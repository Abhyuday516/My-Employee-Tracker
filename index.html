<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Employees - V6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/isToday.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/isTomorrow.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/relativeTime.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .bg-orange-primary { background-color: #f97316; }
        .text-orange-primary { color: #f97316; }
        .border-orange-primary { border-color: #f97316; }
        .btn-primary { background-color: #f97316; color: white; transition: background-color 0.3s; }
        .btn-primary:hover:not(:disabled) { background-color: #ea580c; }
        .btn-primary:disabled { background-color: #fdba74; cursor: not-allowed; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn-danger { background-color: #dc2626; color: white; transition: background-color 0.3s; }
        .btn-danger:hover { background-color: #b91c1c; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .status-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.25em 1.25em; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); padding-right: 2rem; }
        
        /* New Button Color Styles */
        .btn-action-red { color: #dc2626; }
        .btn-action-red:hover { color: #b91c1c; }
        .btn-action-green { color: #16a34a; }
        .btn-action-green:hover { color: #15803d; }
        .btn-action-purple { color: #9333ea; }
        .btn-action-purple:hover { color: #7e22ce; }

        .approve-btn { width: 24px; height: 24px; border-radius: 9999px; display: flex; align-items: center; justify-content: center; color: white; background-color: #16a34a; }
        .deny-btn { width: 24px; height: 24px; border-radius: 9999px; display: flex; align-items: center; justify-content: center; color: white; background-color: #dc2626; }

        /* Custom Calendar Styles */
        .day-cell {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 2.25rem;
            height: 2.25rem;
            text-align: center;
            cursor: pointer;
            border-radius: 50%;
        }
        .day-cell.has-event::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <!-- Responsive Header using Flexbox + Absolute Centering -->
        <header class="bg-white shadow-md rounded-lg p-4 mb-6 relative flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 sm:h-20">
            <!-- User Info: Left side on desktop -->
            <div id="userInfo" class="hidden sm:w-1/3 text-center sm:text-left">
                <p class="font-semibold text-lg" id="userName"></p>
                <div class="flex items-center justify-center sm:justify-start gap-2">
                    <p class="text-sm text-gray-500" id="userDeptAndRole"></p>
                    <div id="userStatusBadge" class="hidden text-xs font-semibold px-2 py-0.5 rounded-full"></div>
                </div>
            </div>
             <!-- Title: Top on mobile, centered on desktop -->
             <div class="order-first sm:absolute sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2">
                <h1 class="text-2xl sm:text-3xl font-bold text-orange-primary text-center">My Employees</h1>
            </div>
            <!-- Logout: Right side on desktop -->
            <div class="sm:w-1/3 text-center sm:text-right">
                 <button id="logoutButton" class="hidden text-sm font-medium text-red-600 hover:underline">Logout</button>
            </div>
        </header>

        <div id="loading" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center hidden z-50"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-orange-primary"></div></div>
        <div id="message-toast" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-xl transition-opacity duration-300 z-50"></div>

        <section id="loginSection" class="max-w-md mx-auto bg-white p-6 sm:p-8 rounded-lg shadow-xl mt-10">
            <h2 class="text-xl sm:text-2xl font-bold text-center mb-6">Employee Login</h2>
            <form id="loginForm" class="space-y-4">
                <div><label for="employeeId" class="block mb-1 font-medium">Employee ID</label><input type="text" id="employeeId" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                <div><label for="email" class="block mb-1 font-medium">Email</label><input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                <div><label for="password" class="block mb-1 font-medium">Password</label><input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                <button type="submit" id="loginButton" class="w-full btn-primary font-bold py-2.5 px-4 rounded-md">Login</button>
                <p id="loginError" class="text-red-500 text-sm mt-2 text-center"></p>
            </form>
        </section>

        <main id="dashboard" class="hidden">
            <div id="mainDashboardView">
                 <div id="meetingsContainer" class="mb-6 bg-white p-4 sm:p-6 rounded-lg shadow-md">
                    <h3 class="text-lg sm:text-xl font-semibold mb-4">Upcoming Meetings</h3>
                    <div id="meetingsList" class="space-y-4"></div>
                </div>
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md lg:col-span-2">
                        <!-- Responsive Task Header -->
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                            <h3 class="text-lg sm:text-xl font-semibold">My Tasks</h3>
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                               <div class="relative">
                                    <button id="date-picker-button" class="bg-gray-200 rounded-lg py-2 sm:py-1 px-3 text-sm w-full sm:w-40 text-left flex justify-between items-center">
                                        <span id="selected-date-text"></span>
                                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    </button>
                                    <div id="calendar-container" class="hidden absolute z-20 mt-2 w-72 bg-white p-4 rounded-lg shadow-lg right-0 sm:right-auto sm:left-0">
                                        <!-- Calendar will be injected here -->
                                    </div>
                                </div>
                               <button id="openAddTaskModalBtn" class="btn-primary text-sm font-semibold py-2 px-3 rounded-md">Add Personal Task</button>
                               <button id="openDelegateTaskModalBtn" class="btn-primary text-sm font-semibold py-2 px-3 rounded-md">Delegate Task</button>
                            </div>
                        </div>
                        <div id="allTasksList" class="space-y-3 max-h-[40rem] overflow-y-auto pr-2"></div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                            <h3 class="text-lg sm:text-xl font-semibold mb-2">Time Clock & Attendance</h3>
                            <div id="attendanceBox">
                                <p class="text-sm text-center mb-2">Today's Status: <span id="currentDayStatusText" class="font-bold"></span></p>
                                <button id="openRequestAttendanceModalBtn" class="w-full mt-2 btn-secondary font-semibold py-2 px-4 rounded-md">Request Status</button>
                            </div>
                            <div class="text-center border-t mt-4 pt-4">
                                <p class="text-sm text-gray-500 mb-2">Your current clock status is:</p>
                                <p id="clockStatusText" class="text-xl sm:text-2xl font-bold mb-2">-</p>
                                <p id="clockInTimeText" class="text-xs text-gray-500 mb-4 h-4"></p>
                                <button id="clockButton" class="w-full font-bold py-2.5 px-4 rounded-md" disabled>Loading...</button>
                            </div>
                        </div>
                        
                        <div id="actionsBox" class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                            <h3 class="text-lg sm:text-xl font-semibold mb-2">Actions</h3>
                            <div class="space-y-2 mt-4">
                                <button id="openCreateMeetingModalBtn" class="w-full text-left btn-secondary font-semibold py-2 px-4 rounded-md">Create Meeting</button>
                            </div>
                        </div>
                        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                            <h3 class="text-lg sm:text-xl font-semibold mb-4">Requests</h3>
                            <div id="myRequestsList" class="space-y-3 text-sm max-h-60 overflow-y-auto pr-2"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="managementView" class="hidden mt-8"></div>
        </main>
    </div>

    <!-- Modals -->
    <div id="editDelegatedTaskModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white w-full max-w-lg p-6 rounded-lg shadow-xl opacity-0 scale-95">
            <h3 class="text-xl font-semibold mb-4">Edit Delegated Task</h3>
            <form id="editDelegatedTaskForm" class="space-y-4">
                <input type="hidden" id="editDelegatedTaskId">
                <div>
                    <label class="block mb-1 font-medium">Assigned To</label>
                    <p id="editDelegatedAssignee" class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-gray-600"></p>
                </div>
                <div>
                    <label for="editDelegatedTaskDescription" class="block mb-1 font-medium">Task Description</label>
                    <textarea id="editDelegatedTaskDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></textarea>
                </div>
                <div>
                    <label for="editDelegatedTaskAttachmentLink" class="block mb-1 font-medium">Attachment Link (Optional)</label>
                    <input type="url" id="editDelegatedTaskAttachmentLink" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="https://docs.google.com/...">
                </div>
                <div>
                    <label for="editDelegatedTaskDeadline" class="block mb-1 font-medium">Deadline</label>
                    <input type="date" id="editDelegatedTaskDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
            </form>
            <div class="mt-6 flex justify-end space-x-3">
                <button data-modal-close="editDelegatedTaskModal" class="btn-secondary font-semibold py-2 px-4 rounded-md">Cancel</button>
                <button id="submitEditDelegatedTaskBtn" class="btn-primary font-semibold py-2 px-4 rounded-md">Save Changes</button>
            </div>
        </div>
    </div>
    <div id="goodJobModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white w-full max-w-md p-8 rounded-lg shadow-xl text-center">
             <h2 class="text-3xl font-bold text-orange-primary mb-4">GOOD JOB!</h2>
             <p class="text-lg text-gray-700 mb-6">We appreciate what you do.</p>
            <button data-modal-close="goodJobModal" class="btn-primary font-semibold py-2 px-6 rounded-md">Close</button>
        </div>
    </div>
    <div id="submitReportModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white w-full max-w-lg p-6 rounded-lg shadow-xl opacity-0 scale-95">
             <h3 class="text-xl font-semibold mb-4">Submit Task Report</h3>
             <p class="text-sm text-gray-600 mb-4">Enter your report or a link to your work (e.g., Google Drive link). Submitting will mark the task as "Done".</p>
             <textarea id="taskReportInput" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
             <input type="hidden" id="reportTaskId">
            <div class="mt-6 flex justify-end space-x-3">
                <button data-modal-close="submitReportModal" class="btn-secondary font-semibold py-2 px-4 rounded-md">Cancel</button>
                <button id="submitReportBtn" class="btn-primary font-semibold py-2 px-4 rounded-md">Submit Report</button>
            </div>
        </div>
    </div>
    <div id="editTaskModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white w-full max-w-lg p-6 rounded-lg shadow-xl opacity-0 scale-95">
             <h3 class="text-xl font-semibold mb-4">Edit Personal Task</h3>
             <form id="editPersonalTaskForm" class="space-y-4">
                <input type="hidden" id="editTaskId">
                <div>
                    <label for="editPersonalTaskDescription" class="block mb-1 font-medium">Task Description</label>
                    <textarea id="editPersonalTaskDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                </div>
                <div>
                    <label for="editPersonalTaskDeadline" class="block mb-1 font-medium">Deadline</label>
                    <input type="date" id="editPersonalTaskDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
            </form>
            <div class="mt-6 flex justify-end space-x-3">
                <button data-modal-close="editTaskModal" class="btn-secondary font-semibold py-2 px-4 rounded-md">Cancel</button>
                <button id="submitEditPersonalTaskBtn" class="btn-primary font-semibold py-2 px-4 rounded-md">Save Changes</button>
            </div>
        </div>
    </div>
    <div id="requestAttendanceModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-lg shadow-xl opacity-0 scale-95">
             <h3 class="text-xl font-semibold mb-4">Request Attendance</h3>
             <p class="text-sm text-gray-600 mb-4">Submit your attendance status for today. It will be sent for approval.</p>
             <div>
                <label for="workLocation" class="block mb-1 font-medium">Status for Today</label>
                <select id="workLocation" class="w-full px-3 py-2 border border-gray-300 rounded-md" required><option value="WFH">Work From Home (WFH)</option><option value="In Office">In Office</option><option value="Leave">On Leave</option><option value="Half Day">Half Day</option></select>
             </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button data-modal-close="requestAttendanceModal" class="btn-secondary font-semibold py-2 px-4 rounded-md">Cancel</button>
                <button id="submitAttendanceRequestBtn" class="btn-primary font-semibold py-2 px-4 rounded-md">Submit Request</button>
            </div>
        </div>
    </div>
    <div id="clockOutModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white w-full max-w-lg p-6 rounded-lg shadow-xl opacity-0 scale-95">
            <h3 class="text-xl font-semibold mb-2">Clock Out & Log Work</h3>
            <p class="text-sm text-gray-600 mb-4">Select tasks completed this session. They will be marked as "Done".</p>
            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <div><h4 class="font-semibold text-sm mb-2">Assigned Tasks</h4><div id="clockOutAssignedTasksList" class="space-y-2 border-t pt-2"></div></div>
                <div><h4 class="font-semibold text-sm mb-2">Personal Tasks</h4><div id="clockOutPersonalTasksList" class="space-y-2 border-t pt-2"></div></div>
                <div><h4 class="font-semibold text-sm mb-1">Other Work / Manual Notes</h4><textarea id="manualTasks" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Manually log any other work done..."></textarea></div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button data-modal-close="clockOutModal" class="btn-secondary font-semibold py-2 px-4 rounded-md">Cancel</button>
                <button id="submitClockOutBtn" class="btn-primary font-semibold py-2 px-4 rounded-md">Submit & Clock Out</button>
            </div>
        </div>
    </div>
     <div id="addTaskModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white w-full max-w-lg p-6 rounded-lg shadow-xl opacity-0 scale-95">
             <h3 class="text-xl font-semibold mb-4">Add Personal Task</h3>
             <form id="addPersonalTaskForm" class="space-y-4">
                 <div>
                    <label for="newPersonalTaskDescription" class="block mb-1 font-medium">Task Description</label>
                    <textarea id="newPersonalTaskDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Enter task description..."></textarea>
                 </div>
                 <div>
                    <label for="newPersonalTaskDeadline" class="block mb-1 font-medium">Deadline (Optional)</label>
                    <input type="date" id="newPersonalTaskDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                 </div>
             </form>
            <div class="mt-6 flex justify-end space-x-3">
                <button data-modal-close="addTaskModal" class="btn-secondary font-semibold py-2 px-4 rounded-md">Cancel</button>
                <button id="submitNewPersonalTaskBtn" class="btn-primary font-semibold py-2 px-4 rounded-md">Add Task</button>
            </div>
        </div>
    </div>
    <div id="delegateTaskModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white w-full max-w-lg p-6 rounded-lg shadow-xl opacity-0 scale-95">
             <h3 class="text-xl font-semibold mb-4">Delegate Task</h3>
             <form id="delegateTaskForm" class="space-y-4"><div><label for="assignTo" class="block mb-1 font-medium">Assign To</label><select id="assignTo" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></select></div><div><label for="taskDescription" class="block mb-1 font-medium">Task Description</label><textarea id="taskDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></textarea></div><div><label for="taskAttachmentLink" class="block mb-1 font-medium">Attachment Link (Optional)</label><input type="url" id="taskAttachmentLink" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="https://docs.google.com/..."></div><div><label for="taskDeadline" class="block mb-1 font-medium">Deadline</label><input type="date" id="taskDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div></form>
            <div class="mt-6 flex justify-end space-x-3"><button data-modal-close="delegateTaskModal" class="btn-secondary font-semibold py-2 px-4 rounded-md">Cancel</button><button id="submitDelegateTaskBtn" class="btn-primary font-semibold py-2 px-4 rounded-md">Delegate</button></div>
        </div>
    </div>
    <div id="createMeetingModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white w-full max-w-lg p-6 rounded-lg shadow-xl opacity-0 scale-95">
            <h3 class="text-xl font-semibold mb-4">Create New Meeting</h3>
            <form id="createMeetingForm" class="space-y-3"><input type="hidden" id="editMeetingId"><input type="text" id="meetingTitle" class="w-full px-3 py-2 border rounded-md" placeholder="Meeting Title" required><input type="datetime-local" id="meetingDateTime" class="w-full px-3 py-2 border rounded-md" required><input type="text" id="meetingAttendees" class="w-full px-3 py-2 border rounded-md" placeholder="Attendees (e.g., ALL, DM, EM002)" required><input type="url" id="meetingLink" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Google Meet Link"><input type="url" id="meetingAttachmentLink" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Attachment Link (Optional)"><textarea id="meetingDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Meeting Description/Agenda"></textarea></form>
            <div class="mt-6 flex justify-end space-x-3"><button data-modal-close="createMeetingModal" class="btn-secondary font-semibold py-2 px-4 rounded-md">Cancel</button><button id="submitMeetingBtn" class="btn-primary font-semibold py-2 px-4 rounded-md">Create Meeting</button></div>
        </div>
    </div>
    <div id="addEmployeeModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white w-full max-w-lg p-6 rounded-lg shadow-xl opacity-0 scale-95">
             <h3 class="text-xl font-semibold mb-4">Add New Employee</h3>
             <form id="addEmployeeForm" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2"><div><label class="text-sm font-medium">Employee ID</label><input type="text" id="newEmpId" class="w-full mt-1 px-3 py-2 border rounded-md" required></div><div><label class="text-sm font-medium">Full Name</label><input type="text" id="newEmpName" class="w-full mt-1 px-3 py-2 border rounded-md" required></div><div><label class="text-sm font-medium">Email</label><input type="email" id="newEmpEmail" class="w-full mt-1 px-3 py-2 border rounded-md" required></div><div><label class="text-sm font-medium">Password</label><input type="password" id="newEmpPassword" class="w-full mt-1 px-3 py-2 border rounded-md" required><div id="password-strength-feedback" class="text-xs mt-1"></div></div><div><label class="text-sm font-medium">Department</label><select id="newEmpDept" class="w-full mt-1 px-3 py-2 border rounded-md" required><option value="DM">Digital Marketing</option><option value="EM">E-commerce</option><option value="FB">Food & Beverages</option></select></div><div><label class="text-sm font-medium">Role</label><select id="newEmpRole" class="w-full mt-1 px-3 py-2 border rounded-md" required><option value="intern">Intern</option><option value="employee">Employee</option><option value="head">Department Head</option><option value="admin">Admin</option></select></div></form>
            <div class="mt-6 flex justify-end space-x-3"><button data-modal-close="addEmployeeModal" class="btn-secondary font-semibold py-2 px-4 rounded-md">Cancel</button><button id="submitNewEmployeeBtn" class="btn-primary font-semibold py-2 px-4 rounded-md">Add Employee</button></div>
        </div>
    </div>
    <div id="confirmDeleteModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-lg shadow-xl opacity-0 scale-95">
             <h3 class="text-xl font-semibold mb-2">Are you sure?</h3>
             <p class="text-sm text-gray-600 mb-6" id="confirmDeleteText">This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button data-modal-close="confirmDeleteModal" class="btn-secondary font-semibold py-2 px-4 rounded-md">Cancel</button>
                <button id="confirmDeleteBtn" class="btn-danger font-semibold py-2 px-4 rounded-md">Delete</button>
            </div>
        </div>
    </div>

<script>
dayjs.extend(window.dayjs_plugin_isToday);
dayjs.extend(window.dayjs_plugin_isTomorrow);
dayjs.extend(window.dayjs_plugin_relativeTime);

document.addEventListener('DOMContentLoaded', () => {
    // =================================================================================
    // CRITICAL CONFIGURATION: Please verify this URL is correct.
    // This is the most common cause of "failed to fetch" errors.
    // 1. Open your Google Apps Script project.
    // 2. Click "Deploy" > "Manage deployments".
    // 3. Make sure your deployment is "Active".
    // 4. Copy the "Web app" URL and paste it here.
    // 5. IMPORTANT: If you change the script, you must click "Deploy" > "New deployment".
    // =================================================================================
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbw-2Ao8cV_EdoSIac6dglmzsBCVUOiQIVX4iUl2AKSNTh021lUAGQQiGoy97aIaFuy-DQ/exec'; // PASTE YOUR GOOGLE APPS SCRIPT URL HERE
    let currentUser = null;
    let currentClockStatus = 'OUT';
    let assignedTasks = [];
    let personalTasks = [];
    let delegatedTasks = [];
    let allEmployees = [];
    let managedEmployees = { heads: [], employees: [], interns: [] };
    let departments = [];
    let meetings = [];

    // Calendar state
    let selectedDate = dayjs();
    let calendarMonth = dayjs().startOf('month');
    const eventDates = new Set();

    const loginSection = document.getElementById('loginSection');
    const dashboard = document.getElementById('dashboard');
    const mainDashboardView = document.getElementById('mainDashboardView');
    const managementView = document.getElementById('managementView');
    const loginButton = document.getElementById('loginButton');

    function showLoading(isLoading) { document.getElementById('loading').classList.toggle('hidden', !isLoading); }
    function showToast(message, isError = false) {
        const toast = document.getElementById('message-toast');
        toast.textContent = message;
        toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-xl transition-opacity duration-300 z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 4000);
    }
    function openModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); setTimeout(() => document.querySelector(`#${modalId} .modal-content`).classList.add('opacity-100', 'scale-100'), 10); }
    function closeModal(modalId) { document.querySelector(`#${modalId} .modal-content`).classList.remove('opacity-100', 'scale-100'); setTimeout(() => document.getElementById(modalId).classList.add('hidden'), 300); }
    function clearMessages() { document.getElementById('loginError').textContent = ''; }

    async function apiCall(action, payload = {}) {
        loginButton.disabled = true;
        // Do not show loading for background refreshes
        if (action !== 'getEmployeeData') {
            showLoading(true);
        }
        clearMessages();
        payload.employeeId = currentUser ? currentUser.id : payload.employeeId;
        payload.adminId = currentUser ? currentUser.id : payload.adminId;
        if (currentUser) payload.authToken = currentUser.authToken;

        try {
            const response = await fetch(GAS_URL, { method: 'POST', mode: 'cors', credentials: 'omit', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action, ...payload }) });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            if (result.status === 'error') throw new Error(result.message);
            return result;
        } catch (error) {
            console.error('API Call Error:', action, error.message);
            const friendlyMessage = error.message.includes('Failed to fetch') 
                ? 'Failed to connect to the server. Please check your internet connection and verify the Google Apps Script URL.'
                : error.message;
            showToast(friendlyMessage, true);
            return { status: 'error', message: friendlyMessage };
        } finally {
            showLoading(false);
            loginButton.disabled = false;
        }
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const employeeId = document.getElementById('employeeId').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const result = await apiCall('login', { employeeId, email, password });
        if (result.status === 'success') {
            currentUser = { ...result.user, authToken: result.authToken };
            sessionStorage.setItem('myEmployeesUser', JSON.stringify(currentUser));
            loginSection.classList.add('hidden');
            dashboard.classList.remove('hidden');
            showDashboard();
            setInterval(refreshDashboardData, 30000); // Auto-refresh data every 30 seconds
        } else {
            document.getElementById('loginError').textContent = result.message;
        }
    });

    document.getElementById('logoutButton').addEventListener('click', () => {
        currentUser = null;
        sessionStorage.removeItem('myEmployeesUser');
        window.location.reload();
    });

    function checkSession() {
        const storedUser = sessionStorage.getItem('myEmployeesUser');
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            loginSection.classList.add('hidden');
            dashboard.classList.remove('hidden');
            showDashboard();
            setInterval(refreshDashboardData, 30000); // Auto-refresh data every 30 seconds
        }
    }
    
    // Function to refresh data in the background
    async function refreshDashboardData() {
        if (!currentUser) return;
        const data = await apiCall('getEmployeeData');
        if (data.status === 'success') {
            assignedTasks = data.assignedTasks;
            personalTasks = data.personalTasks;
            delegatedTasks = data.delegatedTasks;
            meetings = data.meetings;
            updateEventIndicators();
            renderCalendar();
            renderAllTasks(assignedTasks, personalTasks, delegatedTasks);
        }
    }

    async function showDashboard() {
        mainDashboardView.classList.remove('hidden');
        managementView.classList.add('hidden');
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userDeptAndRole').textContent = `Dept: ${currentUser.department} | Role: ${currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1)}`;
        document.getElementById('userInfo').classList.remove('hidden');
        document.getElementById('logoutButton').classList.remove('hidden');
        
        const isIntern = currentUser.role === 'intern';
        document.getElementById('actionsBox').classList.toggle('hidden', isIntern);
        
        const isManagerial = currentUser.role === 'admin' || currentUser.role === 'head';
        document.getElementById('attendanceBox').classList.toggle('hidden', currentUser.role === 'admin');
        
        const data = await apiCall('getEmployeeData');
        if (data.status === 'success') {
            assignedTasks = data.assignedTasks;
            personalTasks = data.personalTasks;
            delegatedTasks = data.delegatedTasks; 
            meetings = data.meetings;
            currentClockStatus = data.clockStatus || 'OUT';

            initializeCalendar();
            renderTimeClock(data.clockInTime);
            renderAllTasks(assignedTasks, personalTasks, delegatedTasks);
            renderMyRequests(data.myRequests);
            renderMeetings(meetings);
            if (currentUser.role !== 'admin') renderUserStatusBadge(data.currentDayStatus);
            
            if (isManagerial) {
                managementView.classList.remove('hidden');
                managedEmployees = data.managementData.managedEmployees;
                departments = data.managementData.departments;
                renderManagementPanel(data.managementData);
            } else {
                managementView.classList.add('hidden');
            }
        }
    }
    
    async function showManagedDashboard(targetEmployeeId) {
        const result = await apiCall('getManagedEmployeeData', { targetEmployeeId });
        if (result.status === 'success') {
            mainDashboardView.classList.add('hidden');
            
            const getStatusColor = (status) => {
                switch (status) {
                    case 'Done': return 'bg-green-100 text-green-800';
                    case 'Delegated': return 'bg-blue-100 text-blue-800';
                    case 'Pending': return 'bg-yellow-100 text-yellow-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };

            const tasksHtml = result.assignedTasks.length > 0 
                ? result.assignedTasks.map(task => `<div class="p-2 rounded ${getStatusColor(task.status)}"><strong>${task.status}:</strong> ${task.description}</div>`).join('') 
                : '<p>No assigned tasks.</p>';

            const personalTasksHtml = result.personalTasks.length > 0 
                ? result.personalTasks.map(task => `<div class="p-2 rounded ${getStatusColor(task.status)}"><strong>${task.status}:</strong> ${task.description}</div>`).join('') 
                : '<p>No personal tasks.</p>';

            managementView.innerHTML = `
                <div class="mb-4">
                    <button id="backToMainDashboardBtn" class="btn-secondary text-sm font-semibold py-2 px-4 rounded-md">&larr; Back to My Dashboard</button>
                </div>
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Viewing Dashboard for: ${result.targetUser.name}</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Live Status</h3>
                        <p><strong>Today's Attendance:</strong> ${result.currentDayStatus}</p>
                        <p><strong>Clock Status:</strong> ${result.clockStatus}</p>
                        ${result.clockInTime ? `<p><strong>Clocked In At:</strong> ${dayjs(result.clockInTime).format('h:mm A')}</p>` : ''}
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Personal Tasks</h3>
                        <div class="space-y-2 max-h-60 overflow-y-auto">${personalTasksHtml}</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-2">
                        <h3 class="text-xl font-semibold mb-4">Assigned Tasks</h3>
                        <div class="space-y-2 max-h-96 overflow-y-auto">${tasksHtml}</div>
                    </div>
                </div>
            `;
        }
    }

    function renderTimeClock(clockInTime) {
        const el = { status: document.getElementById('clockStatusText'), button: document.getElementById('clockButton'), time: document.getElementById('clockInTimeText') };
        el.button.disabled = false;
        if (currentClockStatus === 'IN') {
            el.status.textContent = 'Clocked In';
            el.status.className = 'text-2xl font-bold mb-2 text-green-600';
            el.button.textContent = 'Clock Out';
            el.button.className = 'w-full font-bold py-2.5 px-4 rounded-md btn-danger';
            el.time.textContent = clockInTime ? `Clocked in at ${dayjs(clockInTime).format('h:mm A')}` : '';
        } else {
            el.status.textContent = 'Clocked Out';
            el.status.className = 'text-2xl font-bold mb-2 text-red-600';
            el.button.textContent = 'Clock In';
            el.button.className = 'w-full font-bold py-2.5 px-4 rounded-md btn-primary';
            el.time.textContent = '';
        }
    }

    function renderAllTasks(assigned, personal, delegated) {
        const listEl = document.getElementById('allTasksList');
        
        const assignedToMe = assigned.filter(task => {
            const deadline = dayjs(task.deadline);
            return deadline.isSame(selectedDate, 'day') || (task.status !== 'Done' && deadline.isBefore(selectedDate, 'day'));
        });

        const personalForDate = personal.filter(task => {
            if (!task.deadline) return false;
            const deadline = dayjs(task.deadline);
            return deadline.isSame(selectedDate, 'day');
        });

        const delegatedForDate = delegated.filter(task => {
             const deadline = dayjs(task.deadline);
            return deadline.isSame(selectedDate, 'day');
        });


        if (assignedToMe.length === 0 && personalForDate.length === 0 && delegatedForDate.length === 0) {
            listEl.innerHTML = `<p class="text-gray-500 p-4 text-center">No tasks due on this date.</p>`;
            return;
        }
        
        const assignedHtml = assignedToMe.map(task => {
            let statusColor = 'bg-yellow-100 text-yellow-800';
            if (task.status === 'Done') statusColor = 'bg-green-100 text-green-800';
            const reportHtml = task.reportSubmission ? `<a href="${task.reportSubmission.startsWith('http') ? task.reportSubmission : 'https://' + task.reportSubmission}" target="_blank" class="text-xs text-blue-600 hover:underline">View Report</a>` : `<button class="submit-report-btn text-xs font-semibold text-orange-600 hover:underline" data-task-id="${task.id}">Submit Report</button>`;
            const attachmentHtml = task.attachmentLink ? `<a href="${task.attachmentLink.startsWith('http') ? task.attachmentLink : 'https://' + task.attachmentLink}" target="_blank" class="text-xs text-indigo-600 hover:underline">View Attachment</a>` : '';
            return `<div class="border rounded-lg p-3"><div class="flex justify-between items-start"><div class="pr-4"><span class="text-xs font-semibold bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full mr-2">Assigned</span><p class="font-medium inline">${task.description}</p></div><select class="task-status-select status-select text-xs font-semibold rounded-md p-1 border-0 ${statusColor}" data-task-id="${task.id}" data-task-type="assigned"><option value="Pending" ${task.status === 'Pending' ? 'selected' : ''}>Pending</option><option value="Done" ${task.status === 'Done' ? 'selected' : ''}>Done</option></select></div><div class="text-xs text-gray-500 mt-1 flex justify-between items-center"><span>Deadline: <span class="font-semibold text-red-600">${dayjs(task.deadline).format('MMM D, YYYY')}</span> | By: ${task.delegatedBy}</span> <div class="flex gap-2">${attachmentHtml} ${reportHtml}</div></div></div>`;
        }).join('');

        const personalHtml = personalForDate.map(task => {
            let statusColor = 'bg-yellow-100 text-yellow-800';
            if (task.status === 'Done') statusColor = 'bg-green-100 text-green-800';
            const deadlineHtml = task.deadline ? `<span>Deadline: <span class="font-semibold text-red-600">${dayjs(task.deadline).format('MMM D, YYYY')}</span></span>` : '';
            return `<div class="border rounded-lg p-3"><div class="flex justify-between items-start"><div class="pr-4 flex-grow"><span class="text-xs font-semibold bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full mr-2">Personal</span><p class="font-medium inline">${task.description}</p></div><div class="flex items-center gap-2"><select class="task-status-select status-select text-xs font-semibold rounded-md p-1 border-0 ${statusColor}" data-task-id="${task.id}" data-task-type="personal"><option value="Pending" ${task.status === 'Pending' ? 'selected' : ''}>Pending</option><option value="Done" ${task.status === 'Done' ? 'selected' : ''}>Done</option></select><button class="edit-task-btn btn-action-purple" data-task-details='${JSON.stringify(task)}'><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button><button class="delete-task-btn btn-action-red" data-task-id="${task.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></div></div><div class="text-xs text-gray-500 mt-1">${deadlineHtml}</div></div>`;
        }).join('');
        
        const delegatedHtml = delegatedForDate.map(task => {
            let statusColor = 'bg-yellow-100 text-yellow-800';
            if (task.status === 'Done') statusColor = 'bg-green-100 text-green-800';
            const attachmentHtml = task.attachmentLink ? `<a href="${task.attachmentLink.startsWith('http') ? task.attachmentLink : 'https://' + task.attachmentLink}" target="_blank" class="text-xs text-indigo-600 hover:underline">View Attachment</a>` : '';
            const reportHtml = (task.status === 'Done' && task.reportSubmission) 
                ? `<a href="${task.reportSubmission.startsWith('http') ? task.reportSubmission : 'https://' + task.reportSubmission}" target="_blank" class="text-xs font-semibold text-blue-600 hover:underline">View Report</a>`
                : '';
            
            return `<div class="border rounded-lg p-3"><div class="flex justify-between items-start"><div class="pr-4 flex-grow"><span class="text-xs font-semibold bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full mr-2">Delegated</span><p class="font-medium inline">${task.description}</p></div><div class="flex items-center gap-2"><span class="text-xs font-semibold rounded-md p-1 border-0 ${statusColor}">${task.status}</span></div></div><div class="text-xs text-gray-500 mt-1 flex justify-between items-center"><span>Deadline: <span class="font-semibold">${dayjs(task.deadline).format('MMM D, YYYY')}</span> | To: ${task.assigneeName}</span><div class="flex gap-2 items-center">${attachmentHtml}${reportHtml}</div></div></div>`;
        }).join('');

        listEl.innerHTML = assignedHtml + personalHtml + delegatedHtml;
    }

    function renderMyRequests(requests) {
        const listEl = document.getElementById('myRequestsList');
        let content = '';
        if (requests && requests.incoming && requests.incoming.length > 0) {
            content += '<div><h4 class="font-bold text-gray-800">Incoming</h4>' + requests.incoming.map(req => `<div class="p-2 rounded-md bg-orange-50 flex justify-between items-center"><span>Approval for ${req.employeeName}: <span class="font-medium">${req.type}</span></span><div class="flex gap-2"><button class="approve-attendance-btn" data-record-id="${req.recordId}" data-approved="true">&#10004;</button><button class="deny-attendance-btn deny-btn" data-record-id="${req.recordId}" data-approved="false">&#10006;</button></div></div>`).join('') + '</div>';
        }
        if (requests && requests.outgoing && requests.outgoing.length > 0) {
            content += '<div><h4 class="font-bold text-gray-800 mt-2">Outgoing</h4>' + requests.outgoing.map(req => {
                let statusColor = 'text-yellow-600';
                if (req.status === 'Approved' || req.status === 'Done') statusColor = 'text-green-600';
                if (req.status === 'Rejected') statusColor = 'text-red-600';
                const desc = req.type === 'Attendance' ? `(${req.request}) on ${dayjs(req.date).format('MMM D')}` : `for ${req.assignee}`;
                return `<div class="p-2 rounded-md bg-gray-50"><span>${req.type} ${desc}: <span class="font-bold ${statusColor}">${req.status}</span></span></div>`;
            }).join('') + '</div>';
        }
        listEl.innerHTML = content || `<p class="text-gray-500">You have no requests.</p>`;
    }

    function renderMeetings(meetings) {
        const container = document.getElementById('meetingsContainer');
        const listEl = document.getElementById('meetingsList');
        if (!meetings || meetings.length === 0) {
            container.classList.remove('hidden');
            listEl.innerHTML = '<p class="text-gray-500 text-center">No upcoming meetings scheduled.</p>';
            return;
        }
        container.classList.remove('hidden');
        listEl.innerHTML = meetings.map(m => {
            const canModify = m.createdBy === currentUser.id || currentUser.role === 'admin';
            const attachmentHtml = m.attachmentLink ? `<a href="${m.attachmentLink.startsWith('http') ? m.attachmentLink : 'https://' + m.attachmentLink}" target="_blank" class="text-xs text-indigo-600 hover:underline">View Attachment</a>` : '';
            return `<div class="border-l-4 border-orange-primary pl-4 py-2"><div class="flex justify-between items-start"><div class="pr-4"><h4 class="font-bold">${m.title}</h4><p class="text-sm text-gray-600">${dayjs(m.dateTime).format('MMM D, YYYY')} at ${dayjs(m.dateTime).format('h:mm A')} (${dayjs(m.dateTime).fromNow()})</p></div><div class="flex gap-2 items-center"><a href="${m.link}" target="_blank" class="btn-primary py-1 px-3 text-sm rounded-md">Join</a> ${canModify ? `<button class="edit-meeting-btn btn-action-purple" data-meeting-id='${JSON.stringify(m)}'><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button><button class="delete-meeting-btn btn-action-red" data-meeting-id="${m.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`: ''}</div></div><div class="flex justify-between items-center"><p class="text-sm mt-2">${m.details}</p>${attachmentHtml}</div></div>`
        }).join('');
    }

     function renderUserStatusBadge(status) {
        const badge = document.getElementById('userStatusBadge');
        badge.textContent = status;
        badge.className = "text-xs font-semibold px-2 py-0.5 rounded-full ";
        switch(status) {
            case 'WFH': badge.classList.add('bg-blue-100', 'text-blue-800'); break;
            case 'In Office': badge.classList.add('bg-green-100', 'text-green-800'); break;
            case 'Leave': case 'Holiday': badge.classList.add('bg-yellow-100', 'text-yellow-800'); break;
            default: badge.classList.add('bg-gray-100', 'text-gray-800');
        }
        badge.classList.remove('hidden');
    }

    function renderManagementPanel(managementData) {
        const panelEl = document.getElementById('managementView');
        const title = currentUser.role === 'admin' ? "Admin Panel" : "Department Head Panel";
        panelEl.innerHTML = `<h2 class="text-2xl font-bold mb-4 border-b pb-2">${title}</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"><div><h3 class="text-xl font-semibold mb-4">Team Dashboard</h3><div class="space-y-2"><select id="roleSelector" class="w-full p-2 border rounded"><option value="">Select Role...</option>${currentUser.role === 'admin' ? '<option value="head">Heads</option>' : ''}<option value="employee">Employees</option><option value="intern">Interns</option></select><select id="employeeSelector" class="w-full p-2 border rounded" disabled><option>Select Employee...</option></select><button id="viewManagedDashboardBtn" class="w-full btn-primary font-semibold py-2 px-4 rounded-md mt-2" disabled>View Dashboard</button></div></div><div><h3 class="text-xl font-semibold mb-4">User Management</h3><div class="space-y-2"><button id="openAddEmployeeModalBtn" class="w-full text-left bg-gray-100 hover:bg-gray-200 font-semibold py-2 px-4 rounded-md">Add New Employee</button></div></div></div>`;
    }

    // --- Custom Calendar Logic ---
    function initializeCalendar() {
        document.getElementById('selected-date-text').textContent = selectedDate.format('MMM D, YYYY');
        updateEventIndicators();
        renderCalendar();

        document.getElementById('date-picker-button').addEventListener('click', () => {
            document.getElementById('calendar-container').classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            const calendarContainer = document.getElementById('calendar-container');
            const datePickerButton = document.getElementById('date-picker-button');
            if (!calendarContainer.classList.contains('hidden') && !calendarContainer.contains(e.target) && !datePickerButton.contains(e.target)) {
                calendarContainer.classList.add('hidden');
            }
        });
    }

    function updateEventIndicators() {
        eventDates.clear();
        const allTasks = [...assignedTasks, ...personalTasks, ...delegatedTasks];
        allTasks.forEach(task => {
            if (task.deadline) {
                eventDates.add(dayjs(task.deadline).format('YYYY-MM-DD'));
            }
        });
        meetings.forEach(meeting => {
            if(meeting.dateTime) {
                eventDates.add(dayjs(meeting.dateTime).format('YYYY-MM-DD'));
            }
        });
    }

    function renderCalendar() {
        const calendarContainer = document.getElementById('calendar-container');
        const month = calendarMonth.month();
        const year = calendarMonth.year();
        const firstDay = calendarMonth.startOf('month');
        const lastDay = calendarMonth.endOf('month');
        const daysInMonth = lastDay.date();
        const startDayOfWeek = firstDay.day();

        let html = `
            <div class="flex justify-between items-center mb-2">
                <button id="prev-month" class="p-1 rounded-full hover:bg-gray-100">&lt;</button>
                <div class="font-semibold">${calendarMonth.format('MMMM YYYY')}</div>
                <button id="next-month" class="p-1 rounded-full hover:bg-gray-100">&gt;</button>
            </div>
            <div class="grid grid-cols-7 text-center text-xs text-gray-500">
                <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
            </div>
            <div id="calendar-days" class="grid grid-cols-7 mt-2">
        `;

        // Add blank days for the start of the month
        for (let i = 0; i < startDayOfWeek; i++) {
            html += `<div></div>`;
        }

        // Add day cells
        for (let i = 1; i <= daysInMonth; i++) {
            const day = firstDay.date(i);
            const dateStr = day.format('YYYY-MM-DD');
            let classes = 'day-cell';
            if (eventDates.has(dateStr)) {
                classes += ' has-event';
            }
            if (day.isSame(dayjs(), 'day')) {
                classes += ' bg-orange-100 text-orange-primary';
            }
            if (day.isSame(selectedDate, 'day')) {
                classes += ' bg-orange-primary text-white';
            }
            html += `<div class="${classes}" data-date="${dateStr}">${i}</div>`;
        }
        
        html += `</div>`;
        calendarContainer.innerHTML = html;

        // Add event listeners
        document.getElementById('prev-month').addEventListener('click', () => {
            calendarMonth = calendarMonth.subtract(1, 'month');
            renderCalendar();
        });
        document.getElementById('next-month').addEventListener('click', () => {
            calendarMonth = calendarMonth.add(1, 'month');
            renderCalendar();
        });
        document.querySelectorAll('.day-cell').forEach(cell => {
            cell.addEventListener('click', (e) => {
                const date = e.target.dataset.date;
                if (date) {
                    selectedDate = dayjs(date);
                    document.getElementById('selected-date-text').textContent = selectedDate.format('MMM D, YYYY');
                    renderCalendar(); // Re-render to show selection
                    renderAllTasks(assignedTasks, personalTasks, delegatedTasks);
                    document.getElementById('calendar-container').classList.add('hidden');
                }
            });
        });
    }


    document.getElementById('clockButton').addEventListener('click', () => {
        const clockBtn = document.getElementById('clockButton');
        clockBtn.disabled = true;
        if (currentClockStatus === 'OUT') {
            apiCall('clockIn').then(res => { 
                if (res.status === 'success') {
                    currentClockStatus = 'IN';
                    renderTimeClock(new Date().toISOString());
                } 
                clockBtn.disabled = false;
            });
        } else {
            const assignedListEl = document.getElementById('clockOutAssignedTasksList');
            const personalListEl = document.getElementById('clockOutPersonalTasksList');
            assignedListEl.innerHTML = assignedTasks.length > 0 ? assignedTasks.map(t => `<label class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-50"><input type="checkbox" ${t.status==="Done"?"checked":""} class="h-4 w-4 rounded border-gray-300 text-orange-primary focus:ring-orange-primary" data-task-id="${t.id}" data-task-type="assigned" data-task-desc="${t.description}"><span class="text-sm">${t.description} (${t.status})</span></label>`).join('') : '<p class="text-sm text-gray-500 text-center">No assigned tasks.</p>';
            personalListEl.innerHTML = personalTasks.length > 0 ? personalTasks.map(t => `<label class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-50"><input type="checkbox" ${t.status==="Done"?"checked":""} class="h-4 w-4 rounded border-gray-300 text-orange-primary focus:ring-orange-primary" data-task-id="${t.id}" data-task-type="personal" data-task-desc="${t.description}"><span class="text-sm">${t.description} (${t.status})</span></label>`).join('') : '<p class="text-sm text-gray-500 text-center">No personal tasks.</p>';
            document.getElementById('manualTasks').value = '';
            openModal('clockOutModal');
            clockBtn.disabled = false;
        }
    });

    document.getElementById('submitClockOutBtn').addEventListener('click', async () => {
        const workSummary = { assignedTasks: [], personalTasks: [], manualTasks: document.getElementById('manualTasks').value.trim(), tasksToComplete: [] };
        document.querySelectorAll('#clockOutAssignedTasksList input:checked, #clockOutPersonalTasksList input:checked').forEach(c => {
            workSummary.tasksToComplete.push({ id: c.dataset.taskId, type: c.dataset.taskType });
            if (c.dataset.taskType === 'assigned') workSummary.assignedTasks.push(c.dataset.taskDesc);
            else workSummary.personalTasks.push(c.dataset.taskDesc);
        });
        const result = await apiCall('clockOut', { workSummary });
        if (result.status === 'success') {
            closeModal('clockOutModal');
            openModal('goodJobModal');
            showDashboard();
        }
    });
    
    document.getElementById('submitNewPersonalTaskBtn').addEventListener('click', async () => {
        const description = document.getElementById('newPersonalTaskDescription').value.trim();
        const deadline = document.getElementById('newPersonalTaskDeadline').value;
        if (!description) return;
        const result = await apiCall('addPersonalTask', { description, deadline });
        if (result.status === 'success') {
            personalTasks.push(result.newTask);
            refreshDashboardData();
            closeModal('addTaskModal');
        }
    });

    document.getElementById('allTasksList').addEventListener('change', async (e) => {
        if (e.target.classList.contains('task-status-select')) {
            const taskId = e.target.dataset.taskId;
            const newStatus = e.target.value;
            const taskType = e.target.dataset.taskType;
            const action = taskType === 'personal' ? 'updatePersonalTaskStatus' : 'updateTaskStatus';
            const result = await apiCall(action, { taskId, newStatus });
            if (result.status === 'success') {
                const listToUpdate = taskType === 'personal' ? personalTasks : assignedTasks;
                const taskIndex = listToUpdate.findIndex(t => t.id === taskId);
                if (taskIndex > -1) listToUpdate[taskIndex].status = newStatus;
                e.target.className = 'task-status-select status-select text-xs font-semibold rounded-md p-1 border-0 ';
                if (newStatus === 'Done') e.target.classList.add('bg-green-100', 'text-green-800');
                else e.target.classList.add('bg-yellow-100', 'text-yellow-800');
            }
        }
    });

    document.getElementById('allTasksList').addEventListener('click', async (e) => {
        const deleteButton = e.target.closest('.delete-task-btn');
        const editButton = e.target.closest('.edit-task-btn');
        const reportButton = e.target.closest('.submit-report-btn');
        const editDelegatedButton = e.target.closest('.edit-delegated-task-btn');
        const deleteDelegatedButton = e.target.closest('.delete-delegated-task-btn');

        if (deleteButton) {
            const taskId = deleteButton.dataset.taskId;
            document.getElementById('confirmDeleteBtn').dataset.taskId = taskId;
            document.getElementById('confirmDeleteBtn').dataset.deleteType = 'personalTask';
            document.getElementById('confirmDeleteText').textContent = 'Are you sure you want to delete this personal task? This action cannot be undone.';
            openModal('confirmDeleteModal');
        }
        if (editButton) {
            const task = JSON.parse(editButton.dataset.taskDetails);
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editPersonalTaskDescription').value = task.description;
            document.getElementById('editPersonalTaskDeadline').value = task.deadline ? dayjs(task.deadline).format('YYYY-MM-DD') : '';
            openModal('editTaskModal');
        }
        if (reportButton) {
            const taskId = reportButton.dataset.taskId;
            document.getElementById('reportTaskId').value = taskId;
            document.getElementById('taskReportInput').value = '';
            openModal('submitReportModal');
        }
        if (editDelegatedButton) {
            const task = JSON.parse(editDelegatedButton.dataset.taskDetails);
            document.getElementById('editDelegatedTaskId').value = task.id;
            document.getElementById('editDelegatedAssignee').textContent = `${task.assigneeName} (${task.assigneeId})`;
            document.getElementById('editDelegatedTaskDescription').value = task.description;
            document.getElementById('editDelegatedTaskDeadline').value = dayjs(task.deadline).format('YYYY-MM-DD');
            document.getElementById('editDelegatedTaskAttachmentLink').value = task.attachmentLink || '';
            openModal('editDelegatedTaskModal');
        }
        if (deleteDelegatedButton) {
            const taskId = deleteDelegatedButton.dataset.taskId;
            document.getElementById('confirmDeleteBtn').dataset.taskId = taskId;
            document.getElementById('confirmDeleteBtn').dataset.deleteType = 'delegatedTask';
            document.getElementById('confirmDeleteText').textContent = 'Are you sure you want to delete this delegated task? This will remove it from the assignee\'s list as well.';
            openModal('confirmDeleteModal');
        }
    });

    document.getElementById('meetingsList').addEventListener('click', async (e) => {
        const deleteButton = e.target.closest('.delete-meeting-btn');
        const editButton = e.target.closest('.edit-meeting-btn');
        if (deleteButton) {
            const meetingId = deleteButton.dataset.meetingId;
            document.getElementById('confirmDeleteBtn').dataset.meetingId = meetingId;
            document.getElementById('confirmDeleteBtn').dataset.deleteType = 'meeting';
            document.getElementById('confirmDeleteText').textContent = 'Are you sure you want to delete this meeting? This action cannot be undone.';
            openModal('confirmDeleteModal');
        }
        if (editButton) {
            const meetingData = JSON.parse(editButton.dataset.meetingId);
            const form = document.getElementById('createMeetingForm');
            form.querySelector('#meetingTitle').value = meetingData.title;
            form.querySelector('#meetingDateTime').value = dayjs(meetingData.dateTime).format('YYYY-MM-DDTHH:mm');
            form.querySelector('#meetingAttendees').value = meetingData.attendees;
            form.querySelector('#meetingLink').value = meetingData.link;
            form.querySelector('#meetingDescription').value = meetingData.details;
            form.querySelector('#meetingAttachmentLink').value = meetingData.attachmentLink || '';
            document.getElementById('submitMeetingBtn').dataset.editId = meetingData.id;
            openModal('createMeetingModal');
        }
    });
    
    document.getElementById('confirmDeleteBtn').addEventListener('click', async (e) => {
        const { taskId, meetingId, deleteType } = e.target.dataset;
        let result;
        if (deleteType === 'personalTask') {
            result = await apiCall('deletePersonalTask', { taskId });
        } else if (deleteType === 'meeting') {
            result = await apiCall('deleteMeeting', { meetingId });
        } else if (deleteType === 'delegatedTask') {
            result = await apiCall('deleteDelegatedTask', { taskId });
        }

        if (result && result.status === 'success') {
            closeModal('confirmDeleteModal');
            showDashboard();
            showToast(`Successfully deleted.`);
        }
    });
    
    document.getElementById('dashboard').addEventListener('click', async (e) => {
        if(e.target.id === 'openAddTaskModalBtn') { 
            document.getElementById('addPersonalTaskForm').reset();
            openModal('addTaskModal'); 
        }
        if(e.target.id === 'openCreateMeetingModalBtn') { document.getElementById('createMeetingForm').reset(); delete document.getElementById('submitMeetingBtn').dataset.editId; openModal('createMeetingModal'); }
        if(e.target.id === 'openDelegateTaskModalBtn') {
            if (allEmployees.length === 0) {
                const result = await apiCall('getAllEmployeesForDelegation');
                if(result.status === 'success') allEmployees = result.employees;
            }
             const assignToSelect = document.getElementById('assignTo');
             assignToSelect.innerHTML = allEmployees.map(emp => `<option value="${emp.id}">${emp.name} (${emp.id})</option>`).join('');
             document.getElementById('delegateTaskForm').reset();
             openModal('delegateTaskModal');
        }
        if(e.target.id === 'openRequestAttendanceModalBtn') { openModal('requestAttendanceModal'); }
        if(e.target.id === 'openAddEmployeeModalBtn') {
            document.getElementById('addEmployeeForm').reset();
            document.getElementById('password-strength-feedback').innerHTML = '';
            openModal('addEmployeeModal');
        }
        if(e.target.classList.contains('approve-attendance-btn') || e.target.classList.contains('deny-attendance-btn')){
            const recordId = e.target.dataset.recordId;
            const approved = e.target.dataset.approved === 'true';
            const result = await apiCall('approveAttendance', { recordId, approved });
            if (result.status === 'success') showDashboard();
        }
        if(e.target.id === 'viewManagedDashboardBtn'){
            const employeeSelector = document.getElementById('employeeSelector');
            if(employeeSelector.value) {
                showManagedDashboard(employeeSelector.value);
            }
        }
        if(e.target.id === 'backToMainDashboardBtn'){
            showDashboard();
        }
    });
    
    document.getElementById('managementView').addEventListener('change', async (e) => {
        const roleSelector = document.getElementById('roleSelector');
        const employeeSelector = document.getElementById('employeeSelector');
        const viewBtn = document.getElementById('viewManagedDashboardBtn');

        if(e.target.id === 'roleSelector'){
            const role = roleSelector.value;
            employeeSelector.innerHTML = '<option value="">Select Employee...</option>';
            employeeSelector.disabled = true;
            viewBtn.disabled = true;

            if (role) {
                const dept = currentUser.role === 'head' ? currentUser.department : 'all';
                const { users } = await apiCall('getUsersByRole', { role, department: dept });
                if (users) {
                    employeeSelector.innerHTML += users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
                    employeeSelector.disabled = false;
                }
            }
        }
        if(e.target.id === 'employeeSelector'){
            viewBtn.disabled = !e.target.value;
        }
    });

    document.body.addEventListener('click', (e) => {
        if(e.target.dataset.modalClose) {
            closeModal(e.target.dataset.modalClose);
        }
    });

    document.getElementById('submitDelegateTaskBtn').addEventListener('click', async () => {
        const payload = { assigneeId: document.getElementById('assignTo').value, description: document.getElementById('taskDescription').value, deadline: document.getElementById('taskDeadline').value, attachmentLink: document.getElementById('taskAttachmentLink').value };
        const result = await apiCall('delegateTaskByEmployee', payload);
        if (result.status === 'success') { closeModal('delegateTaskModal'); showDashboard(); }
    });
    
    document.getElementById('submitAttendanceRequestBtn').addEventListener('click', async () => {
        const workLocation = document.getElementById('workLocation').value;
        const result = await apiCall('requestAttendance', { workLocation });
        if (result.status === 'success') { closeModal('requestAttendanceModal'); showDashboard(); }
    });

    document.getElementById('submitMeetingBtn').addEventListener('click', async () => {
        const details = { title: document.getElementById('meetingTitle').value, dateTime: document.getElementById('meetingDateTime').value, attendees: document.getElementById('meetingAttendees').value, link: document.getElementById('meetingLink').value, description: document.getElementById('meetingDescription').value, attachmentLink: document.getElementById('meetingAttachmentLink').value };
        const editId = document.getElementById('submitMeetingBtn').dataset.editId;
        const action = editId ? 'editMeeting' : 'createMeeting';
        if (editId) details.id = editId;

        const result = await apiCall(action, { meetingDetails: details });
        if (result.status === 'success') { closeModal('createMeetingModal'); showDashboard(); }
    });
    
    document.getElementById('submitEditPersonalTaskBtn').addEventListener('click', async () => {
        const taskId = document.getElementById('editTaskId').value;
        const newDescription = document.getElementById('editPersonalTaskDescription').value;
        const newDeadline = document.getElementById('editPersonalTaskDeadline').value;
        const result = await apiCall('editPersonalTask', { taskId, newDescription, newDeadline });
        if(result.status === 'success') {
            closeModal('editTaskModal');
            showDashboard();
        }
    });
    
    document.getElementById('submitEditDelegatedTaskBtn').addEventListener('click', async () => {
        const taskDetails = {
            taskId: document.getElementById('editDelegatedTaskId').value,
            description: document.getElementById('editDelegatedTaskDescription').value,
            deadline: document.getElementById('editDelegatedTaskDeadline').value,
            attachmentLink: document.getElementById('editDelegatedTaskAttachmentLink').value
        };
        const result = await apiCall('editDelegatedTask', { taskDetails });
        if(result.status === 'success') {
            closeModal('editDelegatedTaskModal');
            showDashboard();
        }
    });

    document.getElementById('submitReportBtn').addEventListener('click', async () => {
        const taskId = document.getElementById('reportTaskId').value;
        const report = document.getElementById('taskReportInput').value;
        if (!report.trim()) {
            showToast('Report cannot be empty.', true);
            return;
        }
        const result = await apiCall('submitTaskReport', { taskId, report });
        if(result.status === 'success') {
            closeModal('submitReportModal');
            showDashboard();
        }
    });

    const passwordInput = document.getElementById('newEmpPassword');
    const feedbackDiv = document.getElementById('password-strength-feedback');
    passwordInput.addEventListener('input', () => {
        const password = passwordInput.value;
        let errors = [];
        if (password.length < 8) errors.push("at least 8 characters");
        if (!/[A-Z]/.test(password)) errors.push("an uppercase letter");
        if (!/[a-z]/.test(password)) errors.push("a lowercase letter");
        if (!/[0-9]/.test(password)) errors.push("a number");
        if (!/[^A-Za-z0-9]/.test(password)) errors.push("a special character");
        if (errors.length > 0) feedbackDiv.innerHTML = `<span class="text-red-500">Must contain: ${errors.join(', ')}.</span>`;
        else feedbackDiv.innerHTML = `<span class="text-green-500">Password is strong!</span>`;
    });
    
    document.getElementById('submitNewEmployeeBtn').addEventListener('click', async () => {
        const employeeDetails = {
            employeeId: document.getElementById('newEmpId').value.trim(),
            name: document.getElementById('newEmpName').value.trim(),
            email: document.getElementById('newEmpEmail').value.trim(),
            password: document.getElementById('newEmpPassword').value,
            department: document.getElementById('newEmpDept').value,
            role: document.getElementById('newEmpRole').value
        };
        if (!employeeDetails.employeeId || !employeeDetails.name || !employeeDetails.email || !employeeDetails.password) {
            showToast('Please fill out all required fields.', true);
            return;
        }
        const result = await apiCall('addNewEmployee', { employeeDetails });
        if (result.status === 'success') {
            showToast(result.message);
            closeModal('addEmployeeModal');
        }
    });

    checkSession();
});
</script>

</body>
</html>

