<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Employees - V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/isToday.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/isTomorrow.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .bg-orange-primary { background-color: #f97316; }
        .text-orange-primary { color: #f97316; }
        .border-orange-primary { border-color: #f97316; }
        .btn-primary { background-color: #f97316; color: white; transition: background-color 0.3s; }
        .btn-primary:hover { background-color: #ea580c; }
        .btn-danger { background-color: #dc2626; color: white; transition: background-color 0.3s; }
        .btn-danger:hover { background-color: #b91c1c; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .task-filter-btn.active { background-color: #f97316; color: white; border-color: #f97316; }
        .task-filter-btn { background-color: #e5e7eb; color: #374151; border-color: #e5e7eb;}
        .status-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.25em 1.25em; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); padding-right: 2rem; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <!-- App Container -->
    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">

        <!-- Header -->
        <header class="bg-white shadow-md rounded-lg p-4 mb-6 flex justify-between items-center relative h-20">
            <div id="userInfo" class="hidden absolute left-4 top-1/2 -translate-y-1/2">
                <p class="font-semibold text-lg" id="userName"></p>
                <p class="text-sm text-gray-500" id="userDept"></p>
            </div>
             <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
                <h1 class="text-3xl font-bold text-orange-primary text-center">My Employees</h1>
            </div>
            <div class="absolute right-4 top-1/2 -translate-y-1/2">
                 <button id="logoutButton" class="hidden text-sm font-medium text-red-600 hover:underline">Logout</button>
            </div>
        </header>

        <!-- Loading Spinner & General Message Area -->
        <div id="loading" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-orange-primary"></div>
        </div>
        <div id="message-toast" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-xl transition-opacity duration-300 z-50"></div>

        <!-- Login Section -->
        <section id="loginSection" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-xl mt-10">
            <h2 class="text-2xl font-bold text-center mb-6">Employee Login</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="employeeId" class="block text-sm font-medium mb-1">Employee ID</label>
                    <input type="text" id="employeeId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-primary" required>
                </div>
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-primary" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-primary" required>
                </div>
                <button type="submit" class="w-full btn-primary font-bold py-2.5 px-4 rounded-md">Login</button>
                <p id="loginError" class="text-red-500 text-sm mt-4 text-center"></p>
            </form>
            <div class="text-center mt-6 text-sm text-gray-500">
                <p>Having trouble? Contact us at <a href="mailto:3103abhyuday@gmail.com" class="text-orange-primary hover:underline">3103abhyuday@gmail.com</a></p>
                <p class="mt-2 text-xs italic">Note: Phone/OTP login is a premium feature and not available in this version.</p>
            </div>
        </section>

        <!-- Main Dashboard (Initially Hidden) -->
        <main id="dashboard" class="hidden">
            <div id="universalView">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- My Tasks -->
                    <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-2">
                        <div class="flex justify-between items-center mb-4">
                             <h3 class="text-xl font-semibold">My Tasks</h3>
                             <button id="openDelegateTaskModalBtn" class="btn-primary text-sm font-semibold py-2 px-4 rounded-md">Delegate Task</button>
                        </div>
                        <div class="flex space-x-2 mb-4 border-b pb-2">
                            <button class="task-filter-btn py-1 px-3 rounded-md text-sm font-medium border active" data-filter="today">Today</button>
                            <button class="task-filter-btn py-1 px-3 rounded-md text-sm font-medium border" data-filter="tomorrow">Tomorrow</button>
                            <button class="task-filter-btn py-1 px-3 rounded-md text-sm font-medium border" data-filter="next3days">Next 3 Days</button>
                            <button class="task-filter-btn py-1 px-3 rounded-md text-sm font-medium border" data-filter="all">All</button>
                        </div>
                        <div id="tasksList" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                           <p class="text-gray-500">You have no assigned tasks.</p>
                        </div>
                    </div>
                    
                    <!-- Right Column Wrapper -->
                    <div class="space-y-6">
                        <!-- Time Clock -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-2">Time Clock</h3>
                            <div class="text-center">
                                <p class="text-sm text-gray-500 mb-2">Your current status is:</p>
                                <p id="clockStatusText" class="text-2xl font-bold mb-2">-</p>
                                <p id="clockInTimeText" class="text-xs text-gray-500 mb-4 h-4"></p>
                                <button id="clockButton" class="w-full font-bold py-2.5 px-4 rounded-md">Loading...</button>
                            </div>
                        </div>

                        <!-- My Attendance -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                           <h3 class="text-xl font-semibold mb-4">My Attendance</h3>
                           <div class="space-y-3 mb-4">
                              <label for="workLocation" class="block text-sm font-medium">Mark Today's Attendance:</label>
                              <select id="workLocation" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-primary">
                                  <option>Work from Home</option>
                                  <option>In Office</option>
                                  <option>On Leave</option>
                              </select>
                              <button id="submitAttendanceBtn" class="w-full btn-primary font-semibold py-2 px-4 rounded-md">Submit for Approval</button>
                           </div>
                           <div class="border-t pt-4">
                               <h4 class="font-semibold mb-2">My Recent Requests</h4>
                               <div id="attendanceHistory" class="space-y-2 text-sm max-h-48 overflow-y-auto">
                                   <p class="text-gray-500">No recent requests found.</p>
                               </div>
                           </div>
                       </div>
                    </div>
                    <!-- Meetings -->
                    <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-3">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Upcoming Meetings</h3>
                            <button id="openCreateMeetingModalBtn" class="hidden admin-only btn-primary text-sm font-semibold py-2 px-4 rounded-md">Create Meeting</button>
                        </div>
                        <div id="meetingsList" class="space-y-4">
                            <p class="text-gray-500">No upcoming meetings scheduled.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin-Only View -->
            <div id="adminView" class="hidden admin-only mt-8 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Admin Panel</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Attendance Approvals -->
                    <div>
                         <h3 class="text-xl font-semibold mb-4">Pending Attendance Requests</h3>
                         <div id="pendingAttendanceList" class="space-y-3 max-h-96 overflow-y-auto">
                            <p class="text-gray-500">No pending requests.</p>
                         </div>
                    </div>
                     <!-- Admin Task Oversight -->
                     <div>
                        <h3 class="text-xl font-semibold mb-4">All Delegated Tasks (Oversight)</h3>
                        <div id="adminTasksOversightList" class="space-y-3 max-h-96 overflow-y-auto">
                           <p class="text-gray-500">No tasks delegated yet.</p>
                        </div>
                     </div>
                 </div>
            </div>
        </main>

    </div> <!-- End App Container -->

    <!-- Modals -->
    <!-- Clock Out Modal -->
    <div id="clockOutModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white w-full max-w-lg p-6 rounded-lg shadow-xl opacity-0 scale-95">
            <h3 class="text-xl font-semibold mb-2">Clock Out</h3>
            <p class="text-sm text-gray-600 mb-4">Select the tasks you worked on during this session.</p>
            <div id="clockOutTasksList" class="space-y-2 border-t border-b py-4 max-h-60 overflow-y-auto">
                <!-- Tasks will be populated here -->
            </div>
            <div class="mt-4">
                <label for="otherWork" class="block text-sm font-medium mb-1">Other Work / General Summary</label>
                <textarea id="otherWork" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Describe any other work not listed above..."></textarea>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeModal('clockOutModal')" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md">Cancel</button>
                <button id="submitClockOutBtn" class="btn-primary font-semibold py-2 px-4 rounded-md">Submit & Clock Out</button>
            </div>
        </div>
    </div>
    
    <!-- Delegate Task Modal -->
    <div id="delegateTaskModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white w-full max-w-lg p-6 rounded-lg shadow-xl opacity-0 scale-95">
            <h3 class="text-xl font-semibold mb-4">Delegate a New Task</h3>
            <div class="space-y-4">
                <div>
                    <label for="taskAssignee" class="block text-sm font-medium mb-1">Assign To</label>
                    <select id="taskAssignee" class="w-full px-3 py-2 border border-gray-300 rounded-md"></select>
                </div>
                <div>
                    <label for="taskDescription" class="block text-sm font-medium mb-1">Task Description</label>
                    <textarea id="taskDescription" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                </div>
                <div>
                     <label for="taskDeadline" class="block text-sm font-medium mb-1">Deadline</label>
                     <input type="date" id="taskDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeModal('delegateTaskModal')" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md">Cancel</button>
                <button id="submitTaskDelegationBtn" class="btn-primary font-semibold py-2 px-4 rounded-md">Delegate</button>
            </div>
        </div>
    </div>
    <!-- Create Meeting Modal -->
    <div id="createMeetingModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white w-full max-w-lg p-6 rounded-lg shadow-xl opacity-0 scale-95">
             <h3 class="text-xl font-semibold mb-4">Create a New Meeting</h3>
             <div class="space-y-3 max-h-[70vh] overflow-y-auto pr-2">
                <div><label for="meetingTopic" class="text-sm font-medium">Topic</label><input type="text" id="meetingTopic" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                <div><label for="meetingDateTime" class="text-sm font-medium">Date & Time</label><input type="datetime-local" id="meetingDateTime" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                <div><label for="meetingAttendees" class="text-sm font-medium">Attendees</label><input type="text" id="meetingAttendees" placeholder="e.g., ALL, DM, or specific EmployeeIDs" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                <div><label for="meetingLink" class="text-sm font-medium">Google Meet Link</label><input type="url" id="meetingLink" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                <div><label for="meetingAddress" class="text-sm font-medium">Address (Optional)</label><input type="text" id="meetingAddress" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                <div><label for="meetingFileLink" class="text-sm font-medium">File Link (Optional, e.g., Google Drive)</label><input type="url" id="meetingFileLink" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                <div><label for="meetingDescription" class="text-sm font-medium">Description</label><textarea id="meetingDescription" rows="3" class="w-full mt-1 px-3 py-2 border rounded-md"></textarea></div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeModal('createMeetingModal')" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md">Cancel</button>
                <button id="submitMeetingBtn" class="btn-primary font-semibold py-2 px-4 rounded-md">Create Meeting</button>
            </div>
        </div>
    </div>

    <script>
        dayjs.extend(window.dayjs_plugin_isToday);
        dayjs.extend(window.dayjs_plugin_isTomorrow);

        document.addEventListener('DOMContentLoaded', () => {
            const GAS_URL = 'https://script.google.com/macros/s/AKfycbykxzORIqAqpYVNeHNmNpDhMdtehbOqr0m3NtzN5xSpXmYLyqAIFZHgk6eQxzNrgHT9Nw/exec'; // PASTE YOUR GOOGLE APPS SCRIPT URL HERE
            if (!GAS_URL) {
                document.body.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 max-w-2xl mx-auto rounded-md mt-10" role="alert"><p class="font-bold">Configuration Error:</p><p>The Google Apps Script URL is missing. Please follow the setup instructions, deploy your script, and paste the URL into the <code>GAS_URL</code> variable in this file.</p></div>`;
                return;
            }
            
            let currentUser = null;
            let currentAuthToken = null;
            let currentClockStatus = 'OUT';
            let allEmployees = [];
            let allTasksForAdmin = [];
            let myTasks = [];

            const loadingEl = document.getElementById('loading');
            const toastEl = document.getElementById('message-toast');
            
            const showLoading = (show) => loadingEl.classList.toggle('hidden', !show);
            const showToast = (message, isError = false) => {
                toastEl.textContent = message;
                toastEl.classList.toggle('bg-red-500', isError);
                toastEl.classList.toggle('bg-green-500', !isError);
                toastEl.classList.remove('hidden');
                setTimeout(() => toastEl.classList.add('hidden'), 3000);
            };

            async function apiCall(action, payload = {}) {
                showLoading(true);
                if (currentUser && currentAuthToken) {
                    payload.employeeId = currentUser.id;
                    payload.authToken = currentAuthToken;
                }
                try {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        mode: 'cors',
                        credentials: 'omit',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action, ...payload })
                    });
                    if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                    const result = await response.json();
                    if (result.status === 'error') throw new Error(result.message);
                    return result;
                } catch (error) {
                    console.error(`API Call Error (${action}):`, error);
                    showToast(error.message, true);
                    const loginErrorEl = document.getElementById('loginError');
                    if (loginErrorEl) loginErrorEl.textContent = error.message;
                    return { status: 'error', message: error.message };
                } finally {
                    showLoading(false);
                }
            }
            
            window.openModal = (modalId) => {
                const modal = document.getElementById(modalId);
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
                }, 10);
            }
            window.closeModal = (modalId) => {
                const modal = document.getElementById(modalId);
                modal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }

            function checkSession() {
                const user = sessionStorage.getItem('currentUser');
                const token = sessionStorage.getItem('currentAuthToken');
                if (user && token) {
                    currentUser = JSON.parse(user);
                    currentAuthToken = token;
                    showDashboard();
                }
            }

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                document.getElementById('loginError').textContent = '';
                const result = await apiCall('login', { 
                    employeeId: document.getElementById('employeeId').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    password: document.getElementById('password').value
                });

                if (result.status === 'success') {
                    currentUser = result.user;
                    currentAuthToken = result.authToken;
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    sessionStorage.setItem('currentAuthToken', currentAuthToken);
                    showDashboard();
                }
            });

            document.getElementById('logoutButton').addEventListener('click', () => {
                sessionStorage.clear();
                window.location.reload();
            });

            async function showDashboard() {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('logoutButton').classList.remove('hidden');

                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userDept').textContent = `Dept: ${currentUser.department}`;

                document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', currentUser.role !== 'admin'));

                const data = await apiCall('getEmployeeData');
                if (data.status === 'success') {
                    myTasks = data.tasks;
                    if (data.tasks.allTasksForAdmin) allTasksForAdmin = data.tasks.allTasksForAdmin;
                    currentClockStatus = data.clockStatus || 'OUT';
                    renderTimeClock(data.clockInTime);
                    renderTasks('today');
                    renderMeetings(data.meetings);
                    renderAttendanceHistory(data.attendanceRequests);
                }

                if (currentUser.role === 'admin') {
                    loadAdminData();
                }
            }
            
            async function loadAdminData() {
                const pendingData = await apiCall('getPendingAttendance');
                if(pendingData.status === 'success') renderPendingAttendance(pendingData.requests);
                renderAdminTaskOversight();
            }

            // --- TIME CLOCK FUNCTIONS ---
            function renderTimeClock(clockInTime) {
                const statusTextEl = document.getElementById('clockStatusText');
                const clockButtonEl = document.getElementById('clockButton');
                const clockInTimeEl = document.getElementById('clockInTimeText');
                
                if (currentClockStatus === 'IN') {
                    statusTextEl.textContent = 'Clocked In';
                    statusTextEl.classList.add('text-green-600');
                    statusTextEl.classList.remove('text-red-600');
                    clockButtonEl.textContent = 'Clock Out';
                    clockButtonEl.className = 'w-full font-bold py-2.5 px-4 rounded-md btn-danger';
                    if(clockInTime) {
                       clockInTimeEl.textContent = `Clocked in at ${dayjs(clockInTime).format('h:mm A')}`;
                    }
                } else {
                    statusTextEl.textContent = 'Clocked Out';
                    statusTextEl.classList.add('text-red-600');
                    statusTextEl.classList.remove('text-green-600');
                    clockButtonEl.textContent = 'Clock In';
                    clockButtonEl.className = 'w-full font-bold py-2.5 px-4 rounded-md btn-primary';
                    clockInTimeEl.textContent = '';
                }
            }
            
            document.getElementById('clockButton').addEventListener('click', async () => {
                if (currentClockStatus === 'OUT') {
                    const result = await apiCall('clockIn');
                    if (result.status === 'success') {
                        showToast('You have been successfully clocked in!');
                        showDashboard(); // Reload all data
                    }
                } else {
                    const clockOutTasksListEl = document.getElementById('clockOutTasksList');
                    const pendingTasks = myTasks.filter(t => t.status === 'Pending');
                    if (pendingTasks.length > 0) {
                        clockOutTasksListEl.innerHTML = pendingTasks.map(task => `
                            <label class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-50">
                                <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-orange-primary focus:ring-orange-primary" data-task-desc="${task.description}">
                                <span class="text-sm">${task.description}</span>
                            </label>
                        `).join('');
                    } else {
                         clockOutTasksListEl.innerHTML = '<p class="text-sm text-gray-500 text-center">You have no pending tasks to select.</p>';
                    }
                    document.getElementById('otherWork').value = '';
                    openModal('clockOutModal');
                }
            });

            document.getElementById('submitClockOutBtn').addEventListener('click', async () => {
                const selectedTasks = [];
                document.querySelectorAll('#clockOutTasksList input[type="checkbox"]:checked').forEach(checkbox => {
                    selectedTasks.push(checkbox.dataset.taskDesc);
                });
                const otherWork = document.getElementById('otherWork').value.trim();
                let workSummary = selectedTasks.map(desc => `- ${desc}`).join('\n');
                if (otherWork) {
                    if(workSummary) workSummary += '\n';
                    workSummary += `Other work: ${otherWork}`;
                }
                if (!workSummary) {
                    showToast('Please select tasks or provide a summary of other work.', true);
                    return;
                }
                
                const result = await apiCall('clockOut', { workSummary });
                if (result.status === 'success') {
                    showToast('You have been successfully clocked out!');
                    closeModal('clockOutModal');
                    showDashboard(); // Reload all data
                }
            });

            // --- TASK FUNCTIONS ---
            document.querySelectorAll('.task-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelector('.task-filter-btn.active').classList.remove('active');
                    btn.classList.add('active');
                    renderTasks(btn.dataset.filter);
                });
            });

            function renderTasks(filter) {
                const tasksListEl = document.getElementById('tasksList');
                let tasksToRender = Array.isArray(myTasks) ? myTasks : [];
                
                if (filter === 'today') {
                    tasksToRender = tasksToRender.filter(t => dayjs(t.deadline).isToday());
                } else if (filter === 'tomorrow') {
                    tasksToRender = tasksToRender.filter(t => dayjs(t.deadline).isTomorrow());
                } else if (filter === 'next3days') {
                    const today = dayjs().startOf('day');
                    const threeDaysFromNow = today.add(4, 'day');
                    tasksToRender = tasksToRender.filter(t => {
                        const deadline = dayjs(t.deadline);
                        return deadline.isAfter(today) && deadline.isBefore(threeDaysFromNow);
                    });
                }

                if (tasksToRender.length === 0) {
                    tasksListEl.innerHTML = `<p class="text-gray-500 p-4 text-center">No tasks for this period.</p>`;
                    return;
                }
                tasksListEl.innerHTML = tasksToRender.map(task => {
                    let statusColor = 'bg-red-100 text-red-800'; // Pending
                    if (task.status === 'Done') statusColor = 'bg-green-100 text-green-800';
                    if (task.status === 'Delegated') statusColor = 'bg-blue-100 text-blue-800';

                    return `
                    <div class="border rounded-lg p-3">
                        <div class="flex justify-between items-start">
                             <p class="font-medium pr-4">${task.description}</p>
                             <select class="task-status-select status-select text-xs font-semibold rounded-md p-1 border-0 ${statusColor}" data-task-id="${task.id}">
                                <option value="Pending" ${task.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Done" ${task.status === 'Done' ? 'selected' : ''}>Done</option>
                                <option value="Delegated" ${task.status === 'Delegated' ? 'selected' : ''}>Delegated</option>
                             </select>
                        </div>
                        <div class="text-xs text-gray-500 mt-1 flex justify-between">
                            <span>Deadline: <span class="font-semibold text-red-600">${dayjs(task.deadline).format('MMM D, YYYY')}</span></span>
                            <span>By: ${task.delegatedBy}</span>
                        </div>
                    </div>
                `}).join('');
            }

            document.getElementById('tasksList').addEventListener('change', async (e) => {
                if(e.target.classList.contains('task-status-select')) {
                    const taskId = e.target.dataset.taskId;
                    const newStatus = e.target.value;
                    
                    const result = await apiCall('updateTaskStatus', { taskId, newStatus });
                    if(result.status === 'success') {
                        showToast('Task status updated!');
                        const taskIndex = myTasks.findIndex(t => t.id === taskId);
                        if (taskIndex > -1) myTasks[taskIndex].status = newStatus;
                        e.target.className = 'task-status-select status-select text-xs font-semibold rounded-md p-1 border-0 ';
                        if (newStatus === 'Done') e.target.classList.add('bg-green-100', 'text-green-800');
                        else if (newStatus === 'Delegated') e.target.classList.add('bg-blue-100', 'text-blue-800');
                        else e.target.classList.add('bg-red-100', 'text-red-800');
                    }
                }
            });
            
            function renderMeetings(meetings) { /* Unchanged */ }
            document.getElementById('submitAttendanceBtn').addEventListener('click', async () => { /* Unchanged */ });
            function renderAttendanceHistory(requests) { /* Unchanged */ }
            document.getElementById('openDelegateTaskModalBtn').addEventListener('click', async () => { /* Unchanged */ });
            document.getElementById('submitTaskDelegationBtn').addEventListener('click', async () => { /* Unchanged */ });
            document.getElementById('openCreateMeetingModalBtn').addEventListener('click', () => openModal('createMeetingModal'));
            document.getElementById('submitMeetingBtn').addEventListener('click', async () => { /* Unchanged */ });
            function renderPendingAttendance(requests) { /* Unchanged */ }
            document.getElementById('pendingAttendanceList').addEventListener('click', async (e) => { /* Unchanged */ });
            function renderAdminTaskOversight() { /* Unchanged */ }
            
            checkSession();
        });
    </script>
</body>
</html>

